<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carnet EPS — Classes · Appel · Notes · Groupes</title>
<style>
:root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--card:#ffffff;--border:#e5e7eb;--primary:#1463ff;--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444;--cm:#7c3aed;--disp:#0891b2;--pd:#10b981;--oubli:#f97316}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu;color:var(--ink);background:linear-gradient(180deg,#eef2ff,transparent 300px) var(--bg)}
.container{max-width:980px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:18px}
.center{display:grid;place-items:center;min-height:68vh;text-align:center}
.h1{font-size:38px;font-weight:900;margin:0 0 12px}
.sub{color:var(--muted);margin:0 0 32px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:14px;border:1px solid transparent;background:var(--primary);color:#fff;font-weight:800;cursor:pointer;text-decoration:none}
.btn.secondary{background:#fff;color:var(--ink);border-color:var(--border)}
.btn.ok{background:var(--ok)}.btn.warn{background:var(--warn);color:#1f2937}.btn.danger{background:var(--danger)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
label{font-weight:600}
input[type=text],input[type=date],input[type=number],textarea,select{border:1px solid var(--border);border-radius:10px;padding:8px 10px;font:inherit;background:#fff}
textarea{min-height:80px;resize:vertical}
.hidden{display:none}
.tag{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#f8fafc}
.tablewrap{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border-radius:12px;border:1px solid var(--border)}
thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);font-size:13px;color:#334155}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}
tbody tr:hover{background:#f9fafb}
.footer{opacity:.8;font-size:12px;text-align:center;padding:18px}
.tabs{display:flex;gap:8px;margin:8px 0 12px}
.tabbtn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
.tabbtn.active{background:#eef2ff;border-color:#c7d2fe}
.select-pres.P{background:#eaffea}
.select-pres.A{background:#ffecec}
.select-pres.D{background:#e6fbff}
.select-pres.PD{background:#eafff5}
.select-pres.CM{background:#f3e8ff}
.select-pres.O{background:#fff4e9}
.board{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.pool, .group{border:1px dashed var(--border);border-radius:12px;padding:10px;min-height:180px;background:#fff}
.group{border-style:solid}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:12px}
.draggable{padding:6px 8px;border:1px solid var(--border);border-radius:10px;background:#f8fafc;margin:6px 0;cursor:grab}
.draggable:active{cursor:grabbing}
</style>
</head>
<body>
<div id="app">
  <section id="viewHome" class="center container">
    <div>
      <div class="h1">Carnet EPS</div>
      <p class="sub">Créer classes · Appel (P/A/D/PD/CM/O) · Notes (T1–T3/activité) · Mémo · Groupes drag & drop — Local</p>
      <div class="row" style="justify-content:center">
        <a href="#/create" class="btn">➕ Créer mes classes</a>
        <a href="#/manage" class="btn secondary">📚 Gérer mes classes</a>
      </div>
    </div>
  </section>

  <section id="viewCreate" class="container hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Créer mes classes</h2>
        <a href="#/manage" class="btn secondary">📚 Gérer</a>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Nom de la classe <input type="text" id="newClassName" placeholder="ex : 4B" /></label>
        <button class="btn ok" id="btnCreateClass">Créer classe vide</button>
      </div>
      <hr>
      <div class="row" style="align-items:center">
        <label class="tag">Importer un fichier
          <input type="file" id="fileInput" accept=".csv,.tsv,text/plain" style="margin-left:8px">
        </label>
        <span class="tag">ou</span>
        <span class="small">coller ci-dessous :</span>
      </div>
      <textarea id="pasteArea" placeholder="Collez la liste Pronote ici…"></textarea>
      <div class="row">
        <button class="btn" id="btnImportPaste">Importer à partir du collage</button>
        <span class="tag" id="importInfo">—</span>
      </div>
    </div>
  </section>

  <section id="viewManage" class="container hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Mes classes</h2>
      <a href="#/create" class="btn">➕ Créer/Importer</a>
    </div>
    <div class="row" style="justify-content:space-between;align-items:center;margin:8px 0">
      <div class="row">
        <button class="btn secondary" id="btnExportAll">⬇️ Exporter tout (archive)</button>
        <label class="tag">Restaurer archive
          <input type="file" id="restoreInput" accept="application/json" style="margin-left:8px">
        </label>
      </div>
      <button class="btn danger" id="btnWipe">🧹 Tout effacer</button>
    </div>
    <div id="classesList" class="row"></div>
  </section>

  <section id="viewClass" class="container hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <h2 id="classTitle" style="margin:0">Classe</h2>
        <div class="small" id="classMeta">—</div>
      </div>
      <div class="row">
        <a href="#/manage" class="btn secondary">← Mes classes</a>
        <a id="btnGroups" class="btn warn">🧩 Groupes</a>
        <button class="btn warn" id="btnRenameClass">✏️ Renommer</button>
        <button class="btn danger" id="btnDeleteClass">🗑️ Supprimer</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" data-tab="appel">Appel</button>
      <button class="tabbtn" data-tab="notes">Notes</button>
      <button class="tabbtn" data-tab="memo">Mémo</button>
    </div>

    <div id="tab_appel" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <label>Date <input type="date" id="appelDate"></label>
          <button class="btn ok" id="btnAllP">Tous P (défaut)</button>
          <button class="btn danger" id="btnAllA">Tous A</button>
          <button class="btn secondary" id="btnAllClear">Effacer</button>
        </div>
        <div class="row">
          <button class="btn secondary" id="btnExportToday">⬇️ Export séance</button>
          <button class="btn secondary" id="btnExportCahier">⬇️ Export cahier</button>
        </div>
      </div>
      <div class="tablewrap" style="margin-top:10px">
        <table id="appelTable"><thead><tr><th>Nom</th><th>Prénom</th><th>Présence</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="tab_notes" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <label>Trimestre
            <select id="trimSel"><option value="T1">T1</option><option value="T2">T2</option><option value="T3">T3</option></select>
          </label>
          <label>Activité <input type="text" id="activityInput" placeholder="ex : Badminton" /></label>
          <span class="tag" id="avgTag">Moy. —</span>
        </div>
        <button class="btn secondary" id="btnExportNotes">⬇️ Export notes</button>
      </div>
      <div class="tablewrap" style="margin-top:10px">
        <table id="notesTable"><thead><tr><th>Nom</th><th>Prénom</th><th>Note /20</th><th>Remarque</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="tab_memo" class="card hidden">
      <p class="small">Texte libre par élève.</p>
      <div class="tablewrap" style="margin-top:10px">
        <table id="memoTable"><thead><tr><th>#</th><th>Nom</th><th>Prénom</th><th>Mémo</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Ajouter un élève</h3>
      <div class="row">
        <input type="text" id="inNom" placeholder="Nom" />
        <input type="text" id="inPrenom" placeholder="Prénom" />
        <button class="btn" id="addStudentBtn">Ajouter</button>
      </div>
    </div>
  </section>

  <section id="viewGroups" class="container hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="groupsTitle" style="margin:0">Groupes — </h2>
      <div class="row">
        <a class="btn secondary" id="backToClass">← Retour</a>
        <button class="btn secondary" id="addGroupBtn">+ Groupe</button>
        <button class="btn warn" id="clearGroupsBtn">Vider</button>
        <button class="btn secondary" id="exportGroupsBtn">⬇️ Export groupes</button>
      </div>
    </div>
    <p class="small">Glisser/déposer les noms pour organiser des groupes ou un plan simple.</p>
    <div class="board" id="board">
      <div class="pool" id="pool"><div class="badge">Élèves non placés</div></div>
      <div class="group" data-g="G1"><div class="badge">G1</div></div>
    </div>
  </section>

  <div class="footer">© Carnet EPS — Données locales (LocalStorage). Export/Import JSON. RGPD.</div>
</div>

<script>
(function(){
  const LS_KEY='carnet_eps_adv1';
  const state = load() || {classes:{}, order:[]}; save();
  window.addEventListener('hashchange', onRoute); onRoute();
  function onRoute(){ const h=location.hash||'#/' ; hideAll();
    if(h.startsWith('#/class/')){ showClass(decodeURIComponent(h.split('/')[2]||'')); return; }
    if(h.startsWith('#/groups/')){ showGroups(decodeURIComponent(h.split('/')[2]||'')); return; }
    if(h==='#/create'){ showCreate(); return; }
    if(h==='#/manage'){ showManage(); return; }
    showHome(); }
  function hideAll(){ ['viewHome','viewCreate','viewManage','viewClass','viewGroups'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
  const q=s=>document.querySelector(s);
  const ce=(t,h='')=>{const e=document.createElement(t); e.innerHTML=h; return e;};
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch(e){ return null; } }
  function ensureClass(name){ if(!state.classes[name]){ state.classes[name]={ students:[], presences:{}, notes:{T1:{},T2:{},T3:{}}, activity:{T1:'',T2:'',T3:''}, memo:[], groups:{} }; if(!state.order.includes(name)) state.order.push(name); save(); } }
  function sortByName(a,b){ return (a.nom+' '+a.prenom).localeCompare(b.nom+' '+b.prenom,'fr',{sensitivity:'base'}); }
  function esc(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function rid(){ try{return crypto.randomUUID();}catch(e){return 'id_'+Math.random().toString(36).slice(2);} }

  function showHome(){ document.getElementById('viewHome').classList.remove('hidden'); }
  function showCreate(){
    const v=document.getElementById('viewCreate'); v.classList.remove('hidden');
    q('#btnCreateClass').onclick=()=>{ const name=(q('#newClassName').value.trim()||'Nouvelle classe'); ensureClass(name); location.hash='#/class/'+encodeURIComponent(name); };
    q('#btnImportPaste').onclick=()=>{ const name=(q('#newClassName').value.trim()||'Nouvelle classe'); ensureClass(name); const text=q('#pasteArea').value.trim(); if(!text){ alert('Collez votre liste.'); return;} const added=addFromText(name,text); q('#importInfo').textContent=`${added} élève${added>1?'s':''} ajouté${added>1?'s':''} à ${name}.`; location.hash='#/class/'+encodeURIComponent(name); };
    const file=q('#fileInput'); file.onchange=()=>{ const f=file.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const name=(q('#newClassName').value.trim()||f.name.replace(/\\..+$/,'')); ensureClass(name); const added=addFromText(name,String(r.result||'')); q('#importInfo').textContent=`${added} élève${added>1?'s':''} ajouté${added>1?'s':''} à ${name} (fichier).`; location.hash='#/class/'+encodeURIComponent(name); }; r.readAsText(f,'utf-8'); file.value=''; };
  }
  function addFromText(className,text){ const cls=state.classes[className]; let added=0; text=String(text||'').replace(/^\\uFEFF/,''); const lines=text.split(/\\r?\\n/).map(l=>l.trim()).filter(Boolean);
    for(const raw of lines){ let firstCell=''; const tab=raw.indexOf('\\t'); if(tab>-1) firstCell=raw.slice(0,tab).trim(); else { const si=raw.indexOf(';'),ci=raw.indexOf(','); let pos=-1; if(si>-1&&ci>-1) pos=Math.min(si,ci); else pos=(si>-1?si:(ci>-1?ci:-1)); firstCell=(pos>-1?raw.slice(0,pos):raw).trim(); } if(!firstCell) continue; const tokens=firstCell.split(/\\s+/).filter(Boolean); if(tokens.length<2) continue; const prenom=tokens.pop(); const nom=tokens.join(' '); if(!nom||!prenom) continue; cls.students.push({id:rid(), nom, prenom}); added++; }
    cls.students.sort(sortByName); save(); return added; }

  function showManage(){ const v=document.getElementById('viewManage'); v.classList.remove('hidden'); const list=document.getElementById('classesList'); list.innerHTML=''; state.order=state.order.filter(n=>state.classes[n]);
    if(!state.order.length){ list.innerHTML='<p class="sub">Aucune classe.</p>'; return; }
    for(const name of state.order){ const cls=state.classes[name]; const card=ce('div',`<div class="card"><div class="row" style="justify-content:space-between;align-items:center"><div><b>${esc(name)}</b><div class="small">${cls.students.length} élève${cls.students.length>1?'s':''}</div></div><div class="row"><a class="btn secondary" href="#/class/${encodeURIComponent(name)}">Ouvrir</a><button class="btn warn" data-k="rename">Renommer</button><button class="btn danger" data-k="delete">Supprimer</button></div></div></div>`); list.appendChild(card);
      card.querySelector('[data-k="rename"]').onclick=()=>{ const nv=prompt('Nouveau nom',name); if(!nv||nv===name) return; if(state.classes[nv]){alert('Existe déjà'); return;} state.classes[nv]=cls; delete state.classes[name]; state.order=state.order.map(x=>x===name?nv:x); save(); showManage(); };
      card.querySelector('[data-k="delete"]').onclick=()=>{ if(!confirm('Supprimer ?')) return; delete state.classes[name]; state.order=state.order.filter(x=>x!==name); save(); showManage(); };
    }
    q('#btnExportAll').onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='CarnetEPS_Archive.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); };
    q('#restoreInput').onchange=()=>{ const f=q('#restoreInput').files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(String(r.result||'{}')); if(data&&data.classes){ localStorage.setItem(LS_KEY, JSON.stringify(data)); location.reload(); } else alert('Archive invalide'); }catch(e){ alert('JSON invalide'); } }; r.readAsText(f,'utf-8'); q('#restoreInput').value=''; };
    q('#btnWipe').onclick=()=>{ if(confirm('Tout effacer ?')){ localStorage.removeItem(LS_KEY); location.hash='#/'; location.reload(); } };
  }

  let currentClass='';
  function showClass(name){
    ensureClass(name); currentClass=name;
    document.getElementById('viewClass').classList.remove('hidden');
    q('#classTitle').textContent=name; const cls=state.classes[name]; q('#classMeta').textContent=`${cls.students.length} élève${cls.students.length>1?'s':''}`;
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active')); document.querySelector('[data-tab="appel"]').classList.add('active'); q('#tab_appel').classList.remove('hidden'); q('#tab_notes').classList.add('hidden'); q('#tab_memo').classList.add('hidden');
    document.querySelector('[data-tab="appel"]').onclick=()=>switchTab('appel'); document.querySelector('[data-tab="notes"]').onclick=()=>switchTab('notes'); document.querySelector('[data-tab="memo"]').onclick=()=>switchTab('memo');
    q('#btnRenameClass').onclick=()=>{ const nv=prompt('Nouveau nom',name); if(!nv||nv===name) return; if(state.classes[nv]){alert('Existe déjà'); return;} state.classes[nv]=state.classes[name]; delete state.classes[name]; state.order=state.order.map(x=>x===name?nv:x); save(); location.hash='#/class/'+encodeURIComponent(nv); };
    q('#btnDeleteClass').onclick=()=>{ if(!confirm('Supprimer la classe ?'))return; delete state.classes[name]; state.order=state.order.filter(x=>x!==name); save(); location.hash='#/manage'; };
    q('#btnGroups').onclick=()=> location.hash='#/groups/'+encodeURIComponent(name);

    q('#appelDate').valueAsDate=new Date(); renderAppel();
    q('#btnAllP').onclick=()=>setPresenceAll('P');
    q('#btnAllA').onclick=()=>setPresenceAll('A');
    q('#btnAllClear').onclick=()=>setPresenceAll('');
    q('#btnExportToday').onclick=exportAppelCSV;
    q('#btnExportCahier').onclick=exportCahierCSV;

    q('#trimSel').onchange=renderNotes;
    q('#activityInput').oninput=()=>{ cls.activity[q('#trimSel').value]=q('#activityInput').value; save(); };
    q('#btnExportNotes').onclick=exportNotesCSV;
    renderNotes();

    renderMemo();

    q('#addStudentBtn').onclick=()=>{ const nom=q('#inNom').value.trim(); const prenom=q('#inPrenom').value.trim(); if(!nom||!prenom){alert('Nom & Prénom requis'); return;} cls.students.push({id:rid(), nom, prenom}); cls.students.sort(sortByName); save(); q('#inNom').value=''; q('#inPrenom').value=''; renderAppel(); renderNotes(); renderMemo(); };
  }
  function switchTab(id){ document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active')); document.querySelector(`[data-tab="${id}"]`).classList.add('active'); q('#tab_appel').classList.add('hidden'); q('#tab_notes').classList.add('hidden'); q('#tab_memo').classList.add('hidden'); q('#tab_'+id).classList.remove('hidden'); }

  const PRES_CODES=[{v:'P',label:'Présent',cls:'P'},{v:'A',label:'Absent',cls:'A'},{v:'D',label:'Dispensé',cls:'D'},{v:'PD',label:'Présent dispensé',cls:'PD'},{v:'CM',label:'CM',cls:'CM'},{v:'O',label:'Oubli affaire',cls:'O'}];
  function renderAppel(){ const tbody=q('#appelTable tbody'); tbody.innerHTML=''; const cls=state.classes[currentClass]; cls.students.sort(sortByName); const date=q('#appelDate').value||new Date().toISOString().slice(0,10); cls.presences[date]=cls.presences[date]||{};
    for(const s of cls.students){ if(!(s.id in cls.presences[date])) cls.presences[date][s.id]='P'; const val=cls.presences[date][s.id]||''; const tr=document.createElement('tr'); const opts=PRES_CODES.map(c=>`<option value="${c.v}">${c.label}</option>`).join(''); tr.innerHTML=`<td>${esc(s.nom)}</td><td>${esc(s.prenom)}</td><td><select class="select-pres ${val}" data-id="${s.id}"><option value=""></option>${opts}</select></td>`; tbody.appendChild(tr); const sel=tr.querySelector('select'); sel.value=val; sel.onchange=(e)=>{ const v=e.target.value; cls.presences[date][s.id]=v; colorizeSelect(e.target); save(); }; colorizeSelect(sel);} save(); }
  function colorizeSelect(sel){ sel.className='select-pres '+(sel.value||''); }
  function setPresenceAll(v){ const cls=state.classes[currentClass]; const date=q('#appelDate').value||new Date().toISOString().slice(0,10); cls.presences[date]=cls.presences[date]||{}; for(const s of cls.students){ cls.presences[date][s.id]=v; } save(); renderAppel(); }
  function exportAppelCSV(){ const cls=state.classes[currentClass]; const date=q('#appelDate').value||new Date().toISOString().slice(0,10); const rows=[["Nom","Prenom","Presence "+date]]; const pres=cls.presences[date]||{}; cls.students.forEach(s=>rows.push([s.nom,s.prenom,pres[s.id]||''])); downloadCSV(`Appel_${currentClass}_${date}.csv`, rows); }
  function exportCahierCSV(){ const cls=state.classes[currentClass]; const dates=Object.keys(cls.presences).sort(); const header=["Nom","Prenom",...dates.map(d=>"Presence "+d)]; const rows=[header]; for(const s of cls.students){ rows.push([s.nom,s.prenom,...dates.map(d=>(cls.presences[d]||{})[s.id]||'')]); } downloadCSV(`Cahier_${currentClass}.csv`, rows); }

  function renderNotes(){ const tbody=q('#notesTable tbody'); tbody.innerHTML=''; const cls=state.classes[currentClass]; const trim=q('#trimSel').value; q('#activityInput').value=cls.activity[trim]||''; let sum=0,n=0; cls.students.sort(sortByName);
    for(const s of cls.students){ const val=(typeof cls.notes[trim][s.id]==='number'?cls.notes[trim][s.id]:''); const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(s.nom)}</td><td>${esc(s.prenom)}</td><td><input type="number" min="0" max="20" step="0.5" value="${val}" data-id="${s.id}"/></td><td><input type="text" data-k="rem" data-id="${s.id}" placeholder="Remarque…"/></td>`; tbody.appendChild(tr);
      tr.querySelector('input[type="number"]').oninput=(e)=>{ const v=e.target.value; cls.notes[trim][s.id]= v===''?undefined:Number(v); save(); renderNotes(); };
      const rec = cls.memo.find(m=>m.sid===s.id && m.key==='rem_'+trim); const rem = tr.querySelector('input[data-k="rem"]'); rem.value=rec?.val||''; rem.oninput=(e)=> upsertMemo(s.id,'rem_'+trim, e.target.value);
      if(typeof cls.notes[trim][s.id]==='number'){ sum+=cls.notes[trim][s.id]; n++; } } q('#avgTag').textContent=n?`Moy. ${(sum/n).toFixed(2)}/20`:'Moy. —'; }
  function exportNotesCSV(){ const cls=state.classes[currentClass]; const trim=q('#trimSel').value; const act=cls.activity[trim]||''; const rows=[["Nom","Prenom","Trimestre","Activite","Note","Remarque"]]; for(const s of cls.students){ const note=cls.notes[trim][s.id]??''; const rem=(cls.memo.find(m=>m.sid===s.id && m.key==='rem_'+trim)?.val)||''; rows.push([s.nom,s.prenom,trim,act,note,rem]); } downloadCSV(`Notes_${currentClass}_${trim}.csv`, rows); }

  function renderMemo(){ const tbody=q('#memoTable tbody'); tbody.innerHTML=''; const cls=state.classes[currentClass]; cls.students.sort(sortByName); let i=1; for(const s of cls.students){ const rec=cls.memo.find(m=>m.sid===s.id && m.key==='memo')?.val||''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${i++}</td><td>${esc(s.nom)}</td><td>${esc(s.prenom)}</td><td><textarea data-id="${s.id}" placeholder="Texte libre…">${esc(rec)}</textarea></td>`; tbody.appendChild(tr); tr.querySelector('textarea').oninput=(e)=> upsertMemo(s.id,'memo', e.target.value); } }
  function upsertMemo(sid,key,val){ const cls=state.classes[currentClass]; const i=cls.memo.findIndex(m=>m.sid===sid && m.key===key); if(i>-1) cls.memo[i].val=val; else cls.memo.push({sid,key,val}); save(); }

  function showGroups(name){ ensureClass(name); currentClass=name; document.getElementById('viewGroups').classList.remove('hidden'); q('#groupsTitle').textContent='Groupes — '+name; q('#backToClass').onclick=()=> location.hash='#/class/'+encodeURIComponent(name);
    const board=q('#board'); const pool=q('#pool'); board.querySelectorAll('.group').forEach(g=>g.remove()); const cls=state.classes[name]; const groupsSet=new Set(Object.values(cls.groups)); const groupsList=[...groupsSet].filter(Boolean); if(groupsList.length===0) groupsList.push('G1'); for(const g of groupsList){ const col=ce('div',`<div class="group" data-g="${g}"><div class="badge">${g}</div></div>`); board.appendChild(col.firstChild); }
    pool.innerHTML='<div class="badge">Élèves non placés</div>';
    const placed=new Set(); const addChip=(sid,where)=>{ const s=cls.students.find(x=>x.id===sid); if(!s) return; const chip=ce('div',`<div class="draggable" draggable="true" data-id="${sid}">${esc(s.nom)} ${esc(s.prenom)}</div>`).firstChild; where.appendChild(chip); };
    for(const [sid,g] of Object.entries(cls.groups)){ const col=board.querySelector(`.group[data-g="${g}"]`); if(col){ addChip(sid,col); placed.add(sid); } }
    for(const s of cls.students){ if(!placed.has(s.id)) addChip(s.id,pool); }
    enableDnD();
    q('#addGroupBtn').onclick=()=>{ const next='G'+(board.querySelectorAll('.group').length+1); const col=ce('div',`<div class="group" data-g="${next}"><div class="badge">${next}</div></div>`); board.appendChild(col.firstChild); enableDnD(); };
    q('#clearGroupsBtn').onclick=()=>{ if(!confirm('Vider les groupes ?')) return; cls.groups={}; save(); showGroups(name); };
    q('#exportGroupsBtn').onclick=()=>{ const rows=[["Groupe","Nom","Prenom"]]; for(const s of cls.students){ rows.push([cls.groups[s.id]||'', s.nom, s.prenom]); } downloadCSV(`Groupes_${currentClass}.csv`, rows); };
    function enableDnD(){ const cols=board.querySelectorAll('.pool,.group'); cols.forEach(col=>{ col.ondragover=e=>{e.preventDefault();}; col.ondrop=e=>{ const id=e.dataTransfer.getData('text/plain'); const el=document.querySelector(`.draggable[data-id="${id}"]`); col.appendChild(el); const g=col.getAttribute('data-g'); if(g){ cls.groups[id]=g; } else { delete cls.groups[id]; } save(); }; }); board.querySelectorAll('.draggable').forEach(d=>{ d.ondragstart=e=>{ e.dataTransfer.setData('text/plain', d.getAttribute('data-id')); }; }); }
  }

  function downloadCSV(name, rows){ const csv=rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(';')).join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); }
})();
</script>
</body>
</html>
